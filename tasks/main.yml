# prepare
- block: 
  - name: Download oracle DB pre_install package
    get_url:
      url: https://yum.oracle.com/repo/OracleLinux/OL7/latest/x86_64/getPackage/oracle-database-preinstall-{{oracledb_version}}-1.0-1.el7.x86_64.rpm
      dest: '{{oracledb_install_dir}}'

  - name: Install Oracle DB pre_install 
    shell:  yum -y localinstall oracle-database-preinstall-{{oracledb_version}}-1.0-1.el7.x86_64.rpm
    args:
      chdir: '{{oracledb_install_dir}}'

  - name: Delete oracle DB pre_install package 
    shell: rm -rf {{oracledb_install_dir}}/oracle-database-preinstall-*

  when: ansible_distribution == "CentOS"

- name: Install Oracle DB pre_install
  yum:
    name: oracle-database-preinstall-{{oracledb_version}}
    update_cache: yes
  when: ansible_distribution == "OracleLinux"

# install oracle database
- name: Check the oracle DB package exists
  find: 
    paths: '{{oracledb_install_dir}}'
    patterns:
      - "oracle-database-ee-{{oracledb_version}}*.rpm"
  register: oracledb_package

- fail: msg="The Oracle DB package was not detected. Please download it first"  
  when: oracledb_package is defined and oracledb_package.files == []

- name: Install oracle DB, time is long, please be patient
  shell: yum -y localinstall oracle-database-ee-{{oracledb_version}}*.rpm
  args:
    chdir: '{{oracledb_install_dir}}'

# Oracle configuration
- name: Oracle DB initializes the configuration for the first time, time is long, please be patient
  shell: (echo {{oracledb_password}}; echo {{oracledb_password}};) | /etc/init.d/oracledb_ORCLCDB-{{oracledb_version}} configure

- name: Oracle DB ENV configure
  blockinfile:
    path: /home/oracle/.bash_profile
    owner: oracle
    block: |
      export ORACLE_BASE=/opt/oracle
      export ORACLE_HOME=/opt/oracle/product/{{oracledb_version}}/dbhome_1
      export ORACLE_SID=ORACLEDB
      export PATH=$PATH:$ORACLE_HOME/bin
  become: true
  become_user: oracle

- name: Souce environment variables
  shell: source /home/oracle/.bash_profile
  become: true
  become_user: oracle

- name: Configure oracle DB init file
  lineinfile:
      dest: /opt/oracle/product/19c/dbhome_1/dbs/initORACLEDB.ora
      regexp: "<ORACLE_BASE>"
      line: "/opt/oracle"
      backrefs: yes

- name: Configure oracle DB control file
  lineinfile:
      dest: /opt/oracle/product/19c/dbhome_1/dbs/initORACLEDB.ora
      regexp: "control_files = (ora_control1, ora_control2)"
      line: "control_files = (/opt/oracle/oradata/ORCLCDB/control01.ctl, /opt/oracle/oradata/ORCLCDB/control02.ctl)"
      backrefs: yes

- name: Create init dir for oracle DB
  file: path={{item}} recurse=yes state=directory
  with_items:
    - /opt/oracle/admin/orcl/adump
    - /opt/oracle/fast_recovery_area

- name: Set dir permissive for oracle DB
  shell: chown -R  oracle /opt/oracle/
    
- name: Restart and  Enable oracledb.service
  systemd:
    name: oracledb_ORCLCDB-{{oracledb_version}}
    state: restarted
    daemon_reload: yes
    enabled: yes
 
- name: Create soft link for oracle DB
  file:
    src: '{{item.src}}'
    dest: '{{item.dest}}'
    state: link
    force: yes
  with_items:
    - {src: '/run/systemd/generator.late/oracledb_ORCLCDB-{{oracledb_version}}.service' ,dest: /lib/systemd/system/oracledb.service}
    - {src: '/run/systemd/generator.late/oracledb_ORCLCDB-{{oracledb_version}}.service' ,dest: /lib/systemd/system/oracle.service}
    - {src: /opt/oracle/ ,dest: /data/oracle}
    - {src: /etc/oraInst.loc ,dest: /data/config/oraInst.loc}
    - {src: /etc/oraInst.loc ,dest: /data/oracle/oraInst.loc}
    - {src: /etc/oratab ,dest: /data/config/oratab}
    - {src: /etc/oratab ,dest: /data/oracle/oratab}
    - {src: '/etc/sysconfig/oracledb_ORCLCDB-{{oracledb_version}}.conf' ,dest: /data/config/oracledb.conf}
    - {src: '/etc/sysconfig/oracledb_ORCLCDB-{{oracledb_version}}.conf' ,dest: /data/oracle/oracledb.conf}
    - {src: /opt/oracle/cfgtoollogs/dbca/ORCLCDB/ORCLCDB.log ,dest: /data/logs/oracledb.log}
    - {src: /opt/oracle/cfgtoollogs/dbca/ORCLCDB/,dest: /data/logs/oracle}
    - {src: /opt/oracle/cfgtoollogs/dbca/ORCLCDB/,dest: /data/oracle/logs}
    - {src: /opt/oracle/product/19c/dbhome_1/dbs/init.ora,dest: /opt/oracle/product/19c/dbhome_1/dbs/initORACLEDB.ora}

# check service state
- name: Check Oracle DB Service     
  shell: systemctl status oracle | grep Active*
  register: check_oracle_service
  notify: check_oracle_service
 
# Check version,
# must use sudo sh -c to solve the no-root permission
- name: check Oracle DB version
  shell: sudo sh -c "echo `rpm -qa |grep oracle-database-ee` >> /data/logs/install_version.txt"

